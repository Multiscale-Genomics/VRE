
var RepresentationGroup=function(component,name,selection,representations,defaultParameters){selection=typeof selection==='undefined'?null:selection;representations=typeof representations==='undefined'?null:representations;defaultParameters=typeof defaultParameters==='undefined'?{}:defaultParameters;this.component=component;this.name=name;this.selection=selection;this.defaultParameters=defaultParameters;this.visible=false;this.reprList=[];var self=this;if(representations)
representations.forEach(function(repr){self.addRepresentation(null,repr);});};RepresentationGroup.prototype.addRepresentation=function(display_name,repr,selection){selection=typeof selection==='undefined'?null:selection;repr.display_name=display_name;repr.setParameters(this.defaultParameters);if(selection)
repr.setSelection(selection);else if(this.selection)
repr.setSelection(this.selection);repr.setVisibility(false);this.reprList.push(repr);return this;}
RepresentationGroup.prototype.toggle=function(checked){this.visible=checked;this.update();}
RepresentationGroup.prototype.setVisibility=function(what){this.reprList.forEach(function(repr){repr.setVisibility(what);});}
RepresentationGroup.prototype.setParameters=function(what){this.reprList.forEach(function(repr){repr.setParameters(what);});}
RepresentationGroup.prototype.setSelection=function(what){this.reprList.forEach(function(repr){repr.setSelection(what);});}
RepresentationGroup.prototype.update=function(){this.setVisibility(this.visible);}
RepresentationGroup.prototype.all_empty=function(){return this.reprList.every(function(repr){return repr.repr.structureView.atomCount==0;});}
RepresentationGroup.prototype.GUI=function(class_name,enabled){enabled=typeof enabled==='undefined'?false:enabled;if(this.all_empty())return null;var self=this,c=$("<div/>",{"class":class_name})
this.enabled=0;if(enabled){this.toggle(true);}
c.append($("<div/>").append($("<input/>",{"type":"checkbox","id":class_name,"checked":enabled}).click(function(e){self.toggle(this.checked);}),$("<label/>",{"for":class_name}).append(this.name)));if(this.reprList.length>1){var d=$("<div/>",{"class":"naradio"}),radioname=class_name+"radio";this.reprList.forEach(function(repr,i){d.append($("<span/>").append($("<input/>",{"type":"radio","name":radioname,"id":radioname+"_"+i,"checked":i==0}).click(function(e){self.enable(i);}),$("<label/>",{"for":radioname+"_"+i}).append(capitalize(repr.display_name)),"&nbsp;"));});c.append(d);}
this.update();return c;}
var MutuallyExclusiveRepresentationGroup=function(component,name,selection,representations,defaultParameters){RepresentationGroup.call(this,component,name,selection,representations,defaultParameters);this.enabled=-1;};MutuallyExclusiveRepresentationGroup.prototype=Object.create(RepresentationGroup.prototype);MutuallyExclusiveRepresentationGroup.prototype.enable=function(ci){ci=typeof ci==='undefined'?-1:ci;if(ci<this.reprList.length)
this.enabled=ci;this.update();}
MutuallyExclusiveRepresentationGroup.prototype.nenable=function(name){console.log("nen",name);var i=this.reprList.findIndex(function(repr){return repr.name==name;});this.enable(i);return i;}
MutuallyExclusiveRepresentationGroup.prototype.update=function(){this.setVisibility(false);if(this.visible&&this.enabled>=0)
this.reprList[this.enabled].setVisibility(true)}
var AWF=0.3,BWF=0.3,GWF=0.3,CWF=0.3;var Aco="midnightblue",Bco="darkred",Cco=Aco,Gcos=["mediumvioletred","darkorange","pink","silver"],Ncw="gray",Ncs="khaki",Nso=0.5,Pcc="steelblue",Pcs="skyblue",Pco=0.5,Pso=0.5;var BGCOLORS=["lightgray","white","black","powderblue"];var lowsaturation=[0xE6BEBE,0xBEE6BE,0xBEBEE6,0xE6E6AA,0xBEE6E6];var higsaturation=[0xFF7070,0xA0FFA0,0xA0A0FF,0xFFFF70,0x70FFFF];var logos=[0x00720D,0xFFCB00,0x2AB400,0xFF9200,0x70FFFF]
var rgbyc=logos;var NDBColors=NGL.ColormakerRegistry.addSelectionScheme([[rgbyc[0],"DA or A"],[rgbyc[1],"DG or G"],[rgbyc[2],"DT"],[rgbyc[3],"DC or C"],[rgbyc[4],"U"],["gray","*"]]);var DEBUG=false;var stage,repdata,dna_axis,orientation,zoom;var reference_orientation_component=null;$(document).ready(function(e){$("#plots_selector").change(function(){var selected=$(this).children(":selected")[0];var slide_to=parseInt($(selected).attr("data-slide-to"));var carousel_id=$(this).attr("data-target");$(carousel_id).carousel(slide_to);console.log("selector",slide_to)});$("#plots").on('slide.bs.carousel',function(e){var destination=$(e.relatedTarget).index();var select=$("#plots_selector");var option=select.children("[data-slide-to="+destination+"]")[0];console.log(destination,option)
select.val(option.value);});$("#controls-toggler").slideUp();$("#controls-toggler-control").click(function(e){var toggler=$("#controls-toggler");var toggle_icon=$("#controls-openclose");toggler.slideToggle(500);toggle_icon.toggleClass("glyphicon-arrow-right glyphicon-arrow-left")});});function ngl_viewer(AXPATH,BBPATH,CRPATH,PDBPATH,PPATH,IPATH,SPATH){repdata={};stage=new NGL.Stage("viewport",{"cameraType":"orthographic","backgroundColor":"white"});stage.signals.hovered.add(function(d){var msg=getPickingMessage(d,"");$("#tooltip").html(msg);});var pdbRG=stage.loadFile(PDBPATH).then(function(c){var some=do_input(c);$.extend(some,do_interactions(c,PPATH,IPATH,SPATH));return some;},error);var axRG,bbRG,crRG;dna_axis=new NGL.Vector3(0,1,0);if(AXPATH!=""){axRG=stage.loadFile(AXPATH).then(function(c){dna_axis=get_axis(c.structure);reference_orientation_component=c;return c;}).then(do_ax,error);}else{pdbRG.then(function(rg){reference_orientation_component=rg["Nucleic Acid"].component;return rg;});}
if(BBPATH!=""){bbRG=stage.loadFile(BBPATH).then(do_bb,error);}
Promise.all([pdbRG,axRG,bbRG,crRG]).then(function(RG){reference_orientation_component.autoView();RG.forEach(function(rep){$.extend(repdata,rep);});return repdata;}).then(function(RGdata){var lc=$("#"+"lcontrols");if(RGdata["Nucleic Acid"])
lc.append(RGdata["Nucleic Acid"].GUI("nadisplay",true));if(RGdata["Axis"])
lc.append(RGdata["Axis"].GUI("axdisplay",true));if(RGdata["Backbone"])
lc.append(RGdata["Backbone"].GUI("bbdisplay",true));if(RGdata["Groove12"])
lc.append(RGdata["Groove12"].GUI("gr1display",false));if(RGdata["Groove21"])
lc.append(RGdata["Groove21"].GUI("gr2display",false));if(RGdata["Curvature"])
lc.append(RGdata["Curvature"].GUI("crdisplay",true));var rc=$("#"+"rcontrols");if(RGdata["Protein"])
rc.append(RGdata["Protein"].GUI("prodisplay",true));rc.append(GUI_extras(RGdata["Axis"]));more_GUI_extras();});window.addEventListener("resize",function(event){stage.handleResize();},false);}
function GUI_extras(axis){var cdiv=$("<div/>",{"class":"colors"});cdiv.append("BG: ");BGCOLORS.forEach(function(c){cdiv.append($("<a/>",{"class":"dummylink"}).append($("<div/>",{"id":"","class":"cimg"}).css("background-color",c).click(function(e){stage.viewer.setBackground(c);})));});if(!axis)return cdiv;function align(){rotateCameraTo(dna_axis);rotateCameraAxisAngle(cc(new NGL.Vector3(1,0,0)),-Math.PI/2)}
function orient(){reference_orientation_component.autoView(1000);}
var ddiv=$("<div/>",{"class":"buttons"});ddiv.append($("<input/>",{"type":"button","value":"Reset orientation"}).click(orient),$("<br/>"));return[cdiv,ddiv];}
function safariw(data,target){var url=URL.createObjectURL(data);target.location.href=url;}
function more_GUI_extras(){if(typeof window==="undefined")return false;var ua=window.navigator.userAgent,isSafari=(/Safari/i.test(ua)&&!/Chrome/i.test(ua)),safariwin=null;function image(){if(isSafari){safariwin=window.open();safariwin.document.write("<html><head><link rel='stylesheet' href='/static/style.css'></head><body><h1>Curves+ web server</h1><h3>Thank you for your patience...</h3>Please wait while screenshot is being created. This may take a few seconds...</body></html>")}
var fname="screenshot.png"
stage.makeImage({factor:4,antialias:true,trim:false,transparent:false}).then(function(blob){if(isSafari){return safariw(blob,safariwin);}
return NGL.download(blob,fname);});}
var ediv=$("<div/>",{"style":"position:absolute; bottom: 5px; right: 5px;"});ediv.append($("<img/>",{"src":"img/camera.svg","width":"25px"}).click(image));$(stage.viewer.container).css("position","relative").append(ediv);}
getPickingMessage=function(d,prefix){var msg;if(d.atom){msg=d.atom.qualifiedName();}else if(d.bond){msg=d.bond.atom1.qualifiedName();}else{msg="Welcome!";}
return prefix?prefix+" "+msg:msg;};function do_input(comp){return{"Nucleic Acid":new MutuallyExclusiveRepresentationGroup(comp,"Nucleic Acid","nucleic").addRepresentation("Wire",comp.addRepresentation("licorice",{"colorScheme":NDBColors})).addRepresentation("Element",comp.addRepresentation("ball+stick",{"colorScheme":"element"})).addRepresentation("Surface",comp.addRepresentation("surface",{"opacity":Nso,"colorScheme":"uniform","colorValue":Ncs})),"Protein":new MutuallyExclusiveRepresentationGroup(comp,"Protein","protein").addRepresentation("Cartoon",comp.addRepresentation("cartoon",{"colorScheme":"uniform","colorValue":Pcc,"opacity":Pco})).addRepresentation("Wire",comp.addRepresentation("licorice",{"colorScheme":"element"})).addRepresentation("Surface",comp.addRepresentation("surface",{"opacity":Pso,"colorScheme":"uniform","colorValue":Pcs}))};}
function do_ax(comp){return{"Axis":new MutuallyExclusiveRepresentationGroup(comp,"Axis",null).addRepresentation(null,comp.addRepresentation("licorice",{"colorScheme":"uniform","colorValue":Aco,"radius":AWF}))};}
function do_bb(comp){return{"Backbone":new MutuallyExclusiveRepresentationGroup(comp,"Backbone","(:A or :B)").addRepresentation(null,comp.addRepresentation("licorice",{"colorScheme":"uniform","colorValue":Bco,"radius":BWF})),"Groove12":new MutuallyExclusiveRepresentationGroup(comp,"Groove12",":C").addRepresentation(null,comp.addRepresentation("licorice",{"colorScheme":"uniform","colorValue":Gcos[0],"radius":GWF})),"Groove21":new MutuallyExclusiveRepresentationGroup(comp,"Groove21",":D").addRepresentation(null,comp.addRepresentation("licorice",{"colorScheme":"uniform","colorValue":Gcos[1],"radius":GWF})),};}
function do_cr(comp){return{"Curvature":new MutuallyExclusiveRepresentationGroup(comp,"Curvature",null).addRepresentation(null,comp.addRepresentation("licorice",{"colorScheme":"uniform","colorValue":Cco,"radius":CWF}))};}
function read_file(fname,parser,done){$.get(fname).done(function(data){done(parser(data));});}
function parse_pairings(data){var pairings={};var lines=data.split('\n');for(var i=0;i<lines.length-1;i++){var values=lines[i].split('\t');pairings[values[1]]=values[0];}
return pairings;}
function invert_hash(hash){var _hash={};for(var key in hash)
if(hash.hasOwnProperty(key))
_hash[hash[key]]=key;return _hash;}
function parse_interactions(data,pairings){var interactions={};var lines=data.split('\n');for(var i=0;i<lines.length-1;i++){var values=lines[i].split('\t');var key=values[0]+":"+values[1];if(key in pairings)
key=pairings[key];if(!(key in interactions))
interactions[key]=[];interactions[key].push(values);}
return interactions;}
function parse_sequence(data){var sequence=[];var lines=data.split('\n');for(var i=0;i<lines.length-1;i++){var values=lines[i].split('\t');sequence.push(values);}
return sequence;}
function vertical_sequence(sequence,group){var c=$("<ol/>")
sequence.forEach(function(basepair,i){c.append($("<li/>").append($("<a/>").click(function(e){group.nenable(basepair[2]);}).append(basepair[0]+"--"+basepair[1])));});return c;}
function _normalize(name){if(name[0]=="D")
name=name.slice(1);return name;}
function horizontal_sequence(sequence,group){var c=$("<table/>").append($("<tr/>"));c.append($("<th/>",{"class":"seq_initial"}).append("5'-<br/><br/>3'-"));sequence.forEach(function(basepair,i){forb=_normalize(basepair[0]);revb=_normalize(basepair[1]);c.append($("<td/>").click(function(e){group.nenable(basepair[2]);}).append(forb+"<br/>|<br/>"+revb));});c.append($("<th/>",{"class":"seq_final"}).append("-3'<br/><br/>-5'"));return c;}
function do_interactions(comp,pairings_file,interactions_file,sequence_file){var group=new MutuallyExclusiveRepresentationGroup(comp,"Interactions",null);read_file(pairings_file,parse_pairings,function(pairings){read_file(interactions_file,function(data){return parse_interactions(data,pairings);},function(interactions){var rev_pairings=invert_hash(pairings);for(var res1 in interactions){var allresidues=interactions[res1].map(function(values){return values[4]+":"+values[5];});allresidues.push(res1);if(res1 in rev_pairings)
allresidues.push(rev_pairings[res1]);var interactiongroup=new InteractionGroup(comp,res1,"("+allresidues.join(" or ")+")").addRepresentation("Ball&Stick",comp.addRepresentation("ball+stick",{"colorScheme":"element","colorValue":"#006b8f"}));interactions[res1].forEach(function(values){interactiongroup.addInteraction(values[0]+":"+values[1]+"."+values[3],values[4]+":"+values[5]+"."+values[7],hydrophobic=values[8]=="H");});group.addRepresentation(res1,interactiongroup)}});});read_file(sequence_file,parse_sequence,function(sequence){var c=horizontal_sequence(sequence,group);$("#sequence").append(c);});group.toggle(true);return{"Interactions":group};}
function _autoView(component,sele,duration){component.stage.animationControls.zoomMove(component.getCenter(sele),component.getZoom(sele)*0.5,duration);}
var InteractionGroup=function(component,name,selection,representations,defaultParameters){RepresentationGroup.call(this,component,name,selection,representations,defaultParameters);};InteractionGroup.prototype=Object.create(RepresentationGroup.prototype);InteractionGroup.prototype.setVisibility=function(what){this.reprList.forEach(function(repr){repr.setVisibility(what);});if(what){_autoView(this.component,this.selection,1000);}}
InteractionGroup.prototype.all_empty=function(){};InteractionGroup.prototype.GUI=function(){};InteractionGroup.prototype.addInteraction=function(atom1,atom2,hydrophobic){hydrophobic=typeof hydrophobic==='undefined'?false:hydrophobic;var parameters={atomPair:[[atom1,atom2]],labelColor:"black",color:"blue",opacity:0.5,scale:0.25,labelUnit:"angstrom",labelSize:0.75};if(hydrophobic){parameters["labelSize"]=0;parameters["color"]="green";}
this.addRepresentation("distance",this.component.addRepresentation("distance",parameters));return this;}
function error(err){console.log(err);}
function capitalize(string){return string.charAt(0).toUpperCase()+string.slice(1);}
function get_axis(structure){var atoms=structure.atomStore,n=atoms.count-1,x=atoms.x[0]-atoms.x[n],y=atoms.y[0]-atoms.y[n],z=atoms.z[0]-atoms.z[n];return new NGL.Vector3(x,y,z).normalize();}
function rotateCameraTo(end){return null;}
function rotateCameraAxisAngle(axis,angle,target){return null;}
function cc(axis){return null;return moveDirection;}
function invcc(axis){return null;}